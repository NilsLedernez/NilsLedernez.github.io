<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Aegean Trader - Ancient Greek Trading Empire</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: #0a0a0a;
            color: #f4e4c1;
            overflow: hidden;
            height: 100vh;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #8b4513 0%, #6b3410 100%);
            color: #f4e4c1;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #4a2810;
            box-shadow: 0 3px 10px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .header-left h1 {
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin: 0;
        }

        .header-center {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 0.75em;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
        }

        .day-timer {
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #ffd700;
        }

        .header-right {
            display: flex;
            gap: 10px;
        }

        .menu-button {
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: #2c1810;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.4);
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: transparent;
            cursor: grab;
        }

        .map-container:active {
            cursor: grabbing;
        }

        .map-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            transform-origin: center center;
            transition: transform 0.3s ease;
        }

        .map-background {
            width: 100%;
            height: 100%;
            object-fit: cover;
            user-select: none;
            pointer-events: none;
        }

        /* Ports */
        .port {
            position: absolute;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            border: 3px solid #8b4513;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.6);
            transform: translate(-50%, -50%);
            z-index: 10;
            -webkit-tap-highlight-color: transparent;
        }

        .port:hover, .port:active {
            transform: translate(-50%, -50%) scale(1.3);
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.9);
        }

        .port.current {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            border-color: #1e8449;
            box-shadow: 0 0 25px rgba(46, 204, 113, 0.9);
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 25px rgba(46, 204, 113, 0.9); }
            50% { box-shadow: 0 0 35px rgba(46, 204, 113, 1); }
        }

        .port.locked {
            background: #555;
            border-color: #333;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.3;
        }

        .port-label {
            position: absolute;
            top: 35px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: #ffd700;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            white-space: nowrap;
            pointer-events: none;
            border: 1px solid #d4af37;
        }

        .port.locked .port-label {
            color: #888;
        }

        /* Ship */
        .ship {
            position: absolute;
            font-size: 2em;
            transform: translate(-50%, -50%);
            z-index: 20;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.8));
            animation: float 3s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes float {
            0%, 100% { transform: translate(-50%, -50%) translateY(0); }
            50% { transform: translate(-50%, -50%) translateY(-10px); }
        }

        /* Animation Overlay */
        .animation-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 500;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .animation-overlay.active {
            display: flex;
        }

        .animation-content {
            text-align: center;
            color: #f4e4c1;
        }

        .animation-icon {
            font-size: 8em;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .animation-text {
            font-size: 2em;
            margin-bottom: 20px;
        }

        .animation-details {
            font-size: 1.3em;
            line-height: 1.8;
            max-width: 600px;
            margin: 0 auto;
        }

        .animation-storm {
            animation: shake 0.5s ease-in-out infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .animation-pirate {
            animation: swing 0.8s ease-in-out infinite;
        }

        @keyframes swing {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .bankrupt-stamp {
            font-size: 6em;
            color: #e74c3c;
            font-weight: bold;
            transform: rotate(-15deg);
            border: 10px solid #e74c3c;
            padding: 40px 60px;
            margin: 20px;
            text-transform: uppercase;
            letter-spacing: 10px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(to bottom, #f4e4c1 0%, #e8d4a8 100%);
            border-radius: 15px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            border: 5px solid #8b4513;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
            color: #2c1810;
            margin: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 3px solid #8b4513;
            background: linear-gradient(to bottom, #f4e4c1 0%, #e8d4a8 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-header h2 {
            color: #8b4513;
            font-size: 2em;
            margin: 0;
        }

        .close-btn {
            background: #c0392b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
        }

        .close-btn:hover {
            background: #a93226;
        }

        /* Market */
        .goods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .good-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #8b4513;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .good-item.locked {
            opacity: 0.5;
            background: #f0f0f0;
        }

        .good-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .good-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #8b4513;
        }

        .good-price {
            font-size: 1.2em;
            color: #d4af37;
            font-weight: bold;
        }

        .good-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .good-controls input {
            flex: 1;
            padding: 8px;
            border: 2px solid #8b4513;
            border-radius: 5px;
            font-size: 1em;
        }

        .good-controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .buy-btn {
            background: #27ae60;
            color: white;
        }

        .buy-btn:hover {
            background: #229954;
        }

        .sell-btn {
            background: #e74c3c;
            color: white;
        }

        .sell-btn:hover {
            background: #c0392b;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cargo-info {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .stock-info {
            font-size: 0.85em;
            color: #e67e22;
            font-weight: bold;
            margin-top: 5px;
        }

        /* Ship Upgrades */
        .ship-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .ship-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #8b4513;
            text-align: center;
            transition: all 0.3s;
        }

        .ship-card.current {
            border-color: #27ae60;
            background: #e8f8f5;
        }

        .ship-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .ship-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .ship-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #8b4513;
            margin-bottom: 10px;
        }

        .ship-stats {
            text-align: left;
            margin: 15px 0;
            font-size: 0.95em;
        }

        .ship-stats div {
            margin: 5px 0;
        }

        .upgrade-btn, .action-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }

        .upgrade-btn:hover, .action-btn:hover {
            background: #2980b9;
        }

        .sell-ship-btn {
            background: #e67e22;
            margin-top: 5px;
        }

        .sell-ship-btn:hover {
            background: #d35400;
        }

        /* Loan Section */
        .loan-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #f39c12;
            margin-bottom: 20px;
        }

        .loan-section h3 {
            color: #d68910;
            margin-bottom: 15px;
        }

        .loan-info {
            margin: 10px 0;
            line-height: 1.8;
        }

        .loan-warning {
            background: #fadbd8;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e74c3c;
            margin-top: 15px;
            color: #c0392b;
            font-weight: bold;
        }

        /* Progress Section */
        .progress-section {
            background: #e8f8f5;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #16a085;
            margin: 20px 0;
        }

        .progress-item {
            margin: 15px 0;
        }

        .progress-bar {
            width: 100%;
            height: 25px;
            background: #ddd;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #16a085, #1abc9c);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 30px;
            background: white;
            color: #2c1810;
            padding: 15px 25px;
            border-radius: 10px;
            border: 3px solid #8b4513;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            z-index: 300;
            transform: translateX(400px);
            transition: transform 0.3s;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.good {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .notification.bad {
            border-color: #e74c3c;
            background: #fadbd8;
        }

        .notification.warning {
            border-color: #f39c12;
            background: #fff3cd;
        }

        /* Info Panel */
        .info-panel {
            background: rgba(0,0,0,0.7);
            color: #f4e4c1;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #d4af37;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            position: sticky;
            top: 0;
            z-index: 9;
        }

        .info-panel-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1em;
            font-weight: bold;
        }

        /* Market Tabs */
        .market-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 3px solid #8b4513;
        }

        .market-tab {
            padding: 12px 24px;
            background: #d4af37;
            color: #2c1810;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
            border: 2px solid #8b4513;
            border-bottom: none;
            position: relative;
            bottom: -3px;
        }

        .market-tab:hover {
            background: #e6c760;
        }

        .market-tab.active {
            background: #f4e4c1;
            color: #2c1810;
            border-bottom: 3px solid #f4e4c1;
            bottom: -3px;
        }

        .market-tab-content {
            display: none;
        }

        .market-tab-content.active {
            display: block;
        }

        /* Port Info */
        .port-info {
            background: #e8f8f5;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #27ae60;
            margin: 20px 0;
        }

        .travel-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
        }

        .travel-btn:hover {
            background: #2980b9;
        }

        .unlock-message {
            background: #d5f4e6;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #27ae60;
            margin: 15px 0;
            text-align: center;
            color: #27ae60;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
                flex-wrap: wrap;
            }

            .header-left h1 {
                font-size: 1.3em;
            }

            .header-center {
                gap: 15px;
                order: 3;
                width: 100%;
                margin-top: 10px;
                justify-content: space-around;
            }

            .stat-item {
                font-size: 0.85em;
            }

            .stat-value {
                font-size: 1.1em;
            }

            .menu-button {
                padding: 8px 12px;
                font-size: 0.8em;
            }

            .modal-header h2 {
                font-size: 1.5em;
            }

            .goods-grid {
                grid-template-columns: 1fr;
            }

            .ship-grid {
                grid-template-columns: 1fr;
            }

            .port {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }

            .port-label {
                font-size: 0.75em;
            }
        }

        @media (max-width: 480px) {
            .header-left h1 {
                font-size: 1.1em;
            }

            .stat-label {
                font-size: 0.65em;
            }

            .stat-value {
                font-size: 1em;
            }

            .menu-button {
                padding: 6px 10px;
                font-size: 0.75em;
            }

            .modal-header {
                padding: 15px 20px;
            }

            .modal-body {
                padding: 20px;
            }
        }

        /* Touch-friendly interactions */
        @media (hover: none) and (pointer: coarse) {
            .menu-button, .upgrade-btn, .action-btn, .buy-btn, .sell-btn, .close-btn, .travel-btn {
                min-height: 44px;
                min-width: 44px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>‚öì Aegean Trader</h1>
            </div>
            <div class="header-center">
                <div class="stat-item">
                    <div class="stat-label">Drachmas</div>
                    <div class="stat-value" id="money">300</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ship Health</div>
                    <div class="stat-value" id="ship-health" style="color: #27ae60;">100%</div>
                </div>
                <div class="stat-item day-timer" id="day-timer">
                    <div class="stat-label">Day</div>
                    <div class="stat-value" id="day">1</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ship</div>
                    <div class="stat-value" id="ship-type">Merchant</div>
                </div>
            </div>
            <div class="header-right">
                <button class="menu-button" onclick="openMarket()">üèõÔ∏è Market</button>
                <button class="menu-button" onclick="openShipMenu()">‚õµ Ship</button>
                <button class="menu-button" id="bank-button" onclick="openBank()" style="display: none;">üè¶ Bank</button>
                <button class="menu-button" onclick="openLogbook()">üìñ Logbook</button>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container" id="map-container">
            <div class="map-wrapper" id="map-wrapper">
                <img src="IMG_0007.png" class="map-background" id="map-background">
                
                <!-- Ship -->
                <div class="ship" id="ship" style="left: 45%; top: 55%;">‚õµ</div>

                <!-- Ports -->
                <div class="port current" id="port-Athens" style="left: 45%; top: 55%;" onclick="selectPort('Athens')">
                    <div class="port-label">Athens</div>
                </div>
                <div class="port" id="port-Sparta" style="left: 42%; top: 65%;" onclick="selectPort('Sparta')">
                    <div class="port-label">Sparta</div>
                </div>
                <div class="port" id="port-Corinth" style="left: 40%; top: 52%;" onclick="selectPort('Corinth')">
                    <div class="port-label">Corinth</div>
                </div>
                <div class="port locked" id="port-Delos" style="left: 52%; top: 58%;" onclick="selectPort('Delos')">
                    <div class="port-label">üîí Delos</div>
                </div>
                <div class="port locked" id="port-Crete" style="left: 50%; top: 80%;" onclick="selectPort('Crete')">
                    <div class="port-label">üîí Crete</div>
                </div>
                <div class="port locked" id="port-Rhodes" style="left: 70%; top: 75%;" onclick="selectPort('Rhodes')">
                    <div class="port-label">üîí Rhodes</div>
                </div>
                <div class="port locked" id="port-Lesbos" style="left: 58%; top: 35%;" onclick="selectPort('Lesbos')">
                    <div class="port-label">üîí Lesbos</div>
                </div>
                <div class="port locked" id="port-Chios" style="left: 62%; top: 45%;" onclick="selectPort('Chios')">
                    <div class="port-label">üîí Chios</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Animation Overlay -->
    <div class="animation-overlay" id="animation-overlay">
        <div class="animation-content" id="animation-content"></div>
    </div>

    <!-- Travel Modal -->
    <div class="modal" id="travel-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="travel-port-name">Port</h2>
                <button class="close-btn" onclick="closeModal('travel-modal')">‚úï</button>
            </div>
            <div class="modal-body" id="travel-content"></div>
        </div>
    </div>

    <!-- Market Modal -->
    <div class="modal" id="market-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üèõÔ∏è Market at <span id="market-port">Athens</span></h2>
                <button class="close-btn" onclick="closeModal('market-modal')">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="info-panel">
                    <div class="info-panel-item">
                        <span>üí∞ Money:</span>
                        <span id="market-money">300</span>
                        <span>‚öúÔ∏è</span>
                    </div>
                    <div class="info-panel-item">
                        <span>üíº Cargo:</span>
                        <span id="cargo-used">0</span>
                        <span>/</span>
                        <span id="cargo-capacity">50</span>
                        <span>tons</span>
                    </div>
                </div>
                
                <!-- Tabs (only shown in Athens) -->
                <div class="market-tabs" id="market-tabs" style="display: none;">
                    <button class="market-tab active" onclick="switchMarketTab('regular')">Market</button>
                    <button class="market-tab" onclick="switchMarketTab('general')">General Market</button>
                </div>
                
                <!-- Regular Market Tab -->
                <div class="market-tab-content active" id="regular-market-content">
                    <div class="goods-grid" id="goods-grid"></div>
                </div>
                
                <!-- General Market Tab -->
                <div class="market-tab-content" id="general-market-content">
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 3px solid #f39c12; margin-bottom: 20px;">
                        <h3 style="color: #d68910; margin-bottom: 10px;">üèõÔ∏è Athens General Market</h3>
                        <p style="margin-bottom: 15px;">The merchants of Athens will buy <strong>any goods</strong> at <strong>50% of base price</strong> - no questions asked!</p>
                    </div>
                    <div class="goods-grid" id="general-goods-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ship Modal -->
    <div class="modal" id="ship-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚õµ Ship Management</h2>
                <button class="close-btn" onclick="closeModal('ship-modal')">‚úï</button>
            </div>
            <div class="modal-body" id="ship-content"></div>
        </div>
    </div>

    <!-- Bank Modal -->
    <div class="modal" id="bank-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè¶ Bank of Athens</h2>
                <button class="close-btn" onclick="closeModal('bank-modal')">‚úï</button>
            </div>
            <div class="modal-body" id="bank-content"></div>
        </div>
    </div>

    <!-- Logbook Modal -->
    <div class="modal" id="logbook-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìñ Captain's Logbook</h2>
                <button class="close-btn" onclick="closeModal('logbook-modal')">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <div class="market-tabs">
                    <button class="market-tab active" onclick="switchLogbookTab('transactions')">Transactions</button>
                    <button class="market-tab" onclick="switchLogbookTab('progress')">Progress</button>
                </div>
                
                <!-- Transactions Tab (Primary) -->
                <div class="market-tab-content active" id="logbook-transactions-content">
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <select id="transaction-filter" onchange="filterTransactions()" style="padding: 10px; border-radius: 5px; border: 2px solid #8b4513; font-size: 1em;">
                            <option value="all">All Transactions</option>
                            <option value="income">Income</option>
                            <option value="expense">Expenses</option>
                            <option value="storm">Storm Damage</option>
                            <option value="pirate">Pirate Attacks</option>
                            <option value="fee">Trading Fees</option>
                            <option value="goods">Goods Trades</option>
                        </select>
                    </div>
                    <div id="transactions-list"></div>
                </div>
                
                <!-- Progress Tab (Secondary) -->
                <div class="market-tab-content" id="logbook-progress-content"></div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Game State
        const gameState = {
            money: 300,
            day: 1,
            currentPort: 'Athens',
            ship: 'Merchant',
            cargoCapacity: 50,
            maxCargoCapacity: 50,
            shipSpeed: 1,
            shipHealth: 100,
            dailyCost: 20,
            cargo: {},
            portsVisited: new Set(['Athens']),
            totalProfit: 0,
            goodsProfit: {
                'Olive Oil': 0,
                'Wine': 0,
                'Timber': 0,
                'Pottery': 0,
                'Grain': 0,
                'Bronze': 0,
                'Marble': 0,
                'Purple Dye': 0
            },
            unlockedGoods: ['Olive Oil'],
            loan: 0,
            loanTaken: false,
            lastLoanInterestDay: 0,
            hasUpgradedShip: false,
            transactions: [], // {day, type, amount, description, good}
            unitsSoldInPort: 0, // Track units sold in current port visit
            unitsBoughtInPort: 0 // Track units bought in current port visit
        };

        // Distance matrix between all ports (in nautical miles)
        const portDistances = {
            'Athens': {
                'Athens': 0, 'Sparta': 70, 'Corinth': 40, 'Delos': 80,
                'Crete': 150, 'Chios': 120, 'Lesbos': 140, 'Rhodes': 220
            },
            'Sparta': {
                'Athens': 70, 'Sparta': 0, 'Corinth': 50, 'Delos': 90,
                'Crete': 120, 'Chios': 160, 'Lesbos': 180, 'Rhodes': 200
            },
            'Corinth': {
                'Athens': 40, 'Sparta': 50, 'Corinth': 0, 'Delos': 90,
                'Crete': 180, 'Chios': 150, 'Lesbos': 160, 'Rhodes': 250
            },
            'Delos': {
                'Athens': 80, 'Sparta': 90, 'Corinth': 90, 'Delos': 0,
                'Crete': 100, 'Chios': 60, 'Lesbos': 100, 'Rhodes': 140
            },
            'Crete': {
                'Athens': 150, 'Sparta': 120, 'Corinth': 180, 'Delos': 100,
                'Crete': 0, 'Chios': 160, 'Lesbos': 200, 'Rhodes': 150
            },
            'Chios': {
                'Athens': 120, 'Sparta': 160, 'Corinth': 150, 'Delos': 60,
                'Crete': 160, 'Chios': 0, 'Lesbos': 40, 'Rhodes': 140
            },
            'Lesbos': {
                'Athens': 140, 'Sparta': 180, 'Corinth': 160, 'Delos': 100,
                'Crete': 200, 'Chios': 40, 'Lesbos': 0, 'Rhodes': 180
            },
            'Rhodes': {
                'Athens': 220, 'Sparta': 200, 'Corinth': 250, 'Delos': 140,
                'Crete': 150, 'Chios': 140, 'Lesbos': 180, 'Rhodes': 0
            }
        };

        function getDistance(fromPort, toPort) {
            return portDistances[fromPort][toPort];
        }

        // Port Data
        const portData = {
            'Athens': { 
                produces: ['Olive Oil', 'Pottery'], 
                demands: ['Wine', 'Grain', 'Timber'],
                x: 45, 
                y: 55,
                unlockedAt: 'start'
            },
            'Sparta': { 
                produces: ['Bronze', 'Timber'], 
                demands: ['Wine', 'Pottery', 'Grain'],
                x: 42, 
                y: 65,
                unlockedAt: 'start'
            },
            'Corinth': { 
                produces: ['Bronze', 'Pottery'], 
                demands: ['Olive Oil', 'Purple Dye', 'Timber'],
                x: 40, 
                y: 52,
                unlockedAt: 'start'
            },
            'Delos': { 
                produces: ['Marble'], 
                demands: ['Olive Oil', 'Wine', 'Grain'],
                x: 52, 
                y: 58,
                unlockedAt: 'Bireme'
            },
            'Crete': { 
                produces: ['Wine', 'Olive Oil'], 
                demands: ['Bronze', 'Purple Dye', 'Marble'],
                x: 50, 
                y: 80,
                unlockedAt: 'Trireme'
            },
            'Chios': { 
                produces: ['Wine', 'Marble'], 
                demands: ['Grain', 'Bronze', 'Timber'],
                x: 62, 
                y: 45,
                unlockedAt: 'Trireme'
            },
            'Lesbos': { 
                produces: ['Olive Oil', 'Wine', 'Timber'], 
                demands: ['Bronze', 'Pottery', 'Grain'],
                x: 58, 
                y: 35,
                unlockedAt: 'War Galley'
            },
            'Rhodes': { 
                produces: ['Wine', 'Pottery'], 
                demands: ['Grain', 'Timber', 'Bronze'],
                x: 70, 
                y: 75,
                unlockedAt: 'War Galley'
            }
        };

        // Goods Data
        const goodsData = {
            'Olive Oil': { basePrice: 30, icon: 'ü´í', unlockProfit: 0 },
            'Wine': { basePrice: 50, icon: 'üç∑', unlockProfit: 100 },
            'Timber': { basePrice: 35, icon: 'ü™µ', unlockProfit: 500 },
            'Pottery': { basePrice: 40, icon: 'üè∫', unlockProfit: 2000 },
            'Grain': { basePrice: 20, icon: 'üåæ', unlockProfit: 5000 },
            'Bronze': { basePrice: 70, icon: '‚öíÔ∏è', unlockProfit: 10000 },
            'Marble': { basePrice: 60, icon: 'üóø', unlockProfit: 25000 },
            'Purple Dye': { basePrice: 100, icon: 'üé®', unlockProfit: 50000 }
        };

        // Ship Types
        const ships = {
            'Merchant': { 
                capacity: 50, 
                speed: 1, 
                cost: 1000, 
                dailyCost: 20,  // Reduced from 30 (1/3 reduction)
                icon: '‚õµ',
                emoji: '‚õµ'
            },
            'Bireme': { 
                capacity: 80, 
                speed: 1.3, 
                cost: 5000, 
                dailyCost: 53,  // Reduced from 80 (1/3 reduction)
                icon: 'üö¢',
                emoji: 'üö¢'
            },
            'Trireme': { 
                capacity: 120, 
                speed: 1.6, 
                cost: 15000, 
                dailyCost: 100,  // Reduced from 150 (1/3 reduction)
                icon: '‚õ¥Ô∏è',
                emoji: '‚õ¥Ô∏è'
            },
            'War Galley': { 
                capacity: 180, 
                speed: 2, 
                cost: 40000, 
                dailyCost: 167,  // Reduced from 250 (1/3 reduction)
                icon: 'üõ≥Ô∏è',
                emoji: 'üõ≥Ô∏è'
            }
        };

        // Market Prices and Stock
        let marketPrices = {};
        let marketStock = {};
        let marketDemand = {}; // How much ports will buy

        // Initialize market prices and stock
        function initMarketPrices() {
            Object.keys(portData).forEach(port => {
                marketPrices[port] = {};
                marketStock[port] = {};
                marketDemand[port] = {};
                const portInfo = portData[port];
                
                Object.keys(goodsData).forEach(good => {
                    let basePrice = goodsData[good].basePrice;
                    let priceMultiplier = 1;
                    
                    // Produced goods are CHEAP
                    if (portInfo.produces.includes(good)) {
                        priceMultiplier = 0.6 + Math.random() * 0.2;
                        marketStock[port][good] = Math.floor(30 + Math.random() * 20); // 30-50 units
                        marketDemand[port][good] = 0; // Don't buy what they produce
                    }
                    // Demanded goods are EXPENSIVE
                    else if (portInfo.demands.includes(good)) {
                        priceMultiplier = 1.4 + Math.random() * 0.4;
                        marketStock[port][good] = Math.floor(10 + Math.random() * 10); // 10-20 units
                        marketDemand[port][good] = Math.floor(20 + Math.random() * 30); // Will buy 20-50 units
                    }
                    // Randomly available or not
                    else {
                        if (Math.random() < 0.4) { // 40% chance available
                            priceMultiplier = 0.9 + Math.random() * 0.2;
                            marketStock[port][good] = Math.floor(5 + Math.random() * 15); // 5-20 units
                            marketDemand[port][good] = Math.floor(5 + Math.random() * 10); // Will buy 5-15 units
                        } else {
                            marketStock[port][good] = 0; // Not available
                            marketDemand[port][good] = 0; // Won't buy
                        }
                    }
                    
                    marketPrices[port][good] = Math.round(basePrice * priceMultiplier);
                });
            });
        }

        // Zoom and Pan (Pan only, zoom removed)
        let isPanning = false;
        let startX, startY, translateX = 0, translateY = 0;

        const mapWrapper = document.getElementById('map-wrapper');
        const mapContainer = document.getElementById('map-container');

        function updateTransform() {
            mapWrapper.style.transform = `translate(${translateX}px, ${translateY}px)`;
        }

        mapContainer.addEventListener('mousedown', (e) => {
            if (e.target === mapContainer || e.target.classList.contains('map-background')) {
                isPanning = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                mapContainer.style.cursor = 'grabbing';
            }
        });

        mapContainer.addEventListener('mousemove', (e) => {
            if (isPanning) {
                translateX = e.clientX - startX;
                translateY = e.clientY - startY;
                updateTransform();
            }
        });

        mapContainer.addEventListener('mouseup', () => {
            isPanning = false;
            mapContainer.style.cursor = 'grab';
        });

        // Touch support for mobile
        let touchStartX, touchStartY;
        
        mapContainer.addEventListener('touchstart', (e) => {
            if (e.target === mapContainer || e.target.classList.contains('map-background')) {
                isPanning = true;
                touchStartX = e.touches[0].clientX - translateX;
                touchStartY = e.touches[0].clientY - translateY;
            }
        });

        mapContainer.addEventListener('touchmove', (e) => {
            if (isPanning) {
                e.preventDefault();
                translateX = e.touches[0].clientX - touchStartX;
                translateY = e.touches[0].clientY - touchStartY;
                updateTransform();
            }
        });

        mapContainer.addEventListener('touchend', () => {
            isPanning = false;
        });

        // Animations
        function showAnimation(type, details) {
            const overlay = document.getElementById('animation-overlay');
            const content = document.getElementById('animation-content');
            
            let html = '';
            
            if (type === 'travel') {
                const shipEmoji = ships[gameState.ship].emoji;
                html = `
                    <div class="animation-icon">${shipEmoji}</div>
                    <div class="animation-text">Sailing to ${details.destination}...</div>
                    <div class="animation-details">
                        Distance: ${details.distance} nautical miles<br>
                        Travel time: ${details.time}
                    </div>
                `;
                overlay.classList.add('active');
                setTimeout(() => {
                    overlay.classList.remove('active');
                    if (details.callback) details.callback();
                }, 2000);
            }
            else if (type === 'storm') {
                html = `
                    <div class="animation-icon animation-storm">‚õàÔ∏è</div>
                    <div class="animation-text">STORM!</div>
                    <div class="animation-details">
                        ${details.message}
                    </div>
                `;
                overlay.classList.add('active');
                setTimeout(() => {
                    overlay.classList.remove('active');
                }, 3000);
            }
            else if (type === 'pirate') {
                html = `
                    <div class="animation-icon animation-pirate">üè¥‚Äç‚ò†Ô∏è</div>
                    <div class="animation-text">PIRATE ATTACK!</div>
                    <div class="animation-details">
                        ${details.message}
                    </div>
                `;
                overlay.classList.add('active');
                setTimeout(() => {
                    overlay.classList.remove('active');
                }, 3000);
            }
            else if (type === 'bankrupt') {
                html = `
                    <div class="bankrupt-stamp">BANKRUPT</div>
                    <div class="animation-details">
                        ${details.message}<br><br>
                        <button class="upgrade-btn" onclick="restartGame()">Start New Game</button>
                    </div>
                `;
                overlay.classList.add('active');
            }
            
            content.innerHTML = html;
        }

        // Select Port
        let selectedPort = null;

        function calculatePortStayFee() {
            const totalUnitsTraded = gameState.unitsSoldInPort + gameState.unitsBoughtInPort;
            let stayDays = 1; // Default 1 day
            
            if (totalUnitsTraded <= 15) {
                stayDays = 1;
            } else if (totalUnitsTraded <= 40) {
                stayDays = 2;
            } else {
                stayDays = 3;
            }
            
            return {
                days: stayDays,
                cost: stayDays * gameState.dailyCost,
                unitsTraded: totalUnitsTraded
            };
        }

        function selectPort(portName) {
            const port = portData[portName];
            
            if (portName === gameState.currentPort) {
                openMarket();
                return;
            }
            
            // Check if port is unlocked
            if (port.unlockedAt !== 'start') {
                const requiredShip = port.unlockedAt;
                const shipOrder = ['Merchant', 'Bireme', 'Trireme', 'War Galley'];
                const currentShipIndex = shipOrder.indexOf(gameState.ship);
                const requiredShipIndex = shipOrder.indexOf(requiredShip);
                
                if (currentShipIndex < requiredShipIndex) {
                    showNotification(`üîí Upgrade to ${requiredShip} to unlock ${portName}`, 'bad');
                    return;
                }
            }
            
            selectedPort = portName;
            
            // Calculate distance from CURRENT port to selected port
            const distance = getDistance(gameState.currentPort, portName);
            const travelTimeHours = distance / (gameState.shipSpeed * 10); // Adjusted formula for realistic times
            const travelDays = Math.max(1, Math.ceil(travelTimeHours / 24));
            const travelCost = travelDays * gameState.dailyCost;
            const portFee = Math.floor(gameState.dailyCost * 0.25);
            const totalCost = travelCost + portFee;
            
            let timeDisplay;
            if (travelTimeHours < 1) {
                timeDisplay = Math.round(travelTimeHours * 60) + ' minutes';
            } else if (travelTimeHours < 24) {
                timeDisplay = travelTimeHours.toFixed(1) + ' hours';
            } else {
                timeDisplay = travelDays + ' day' + (travelDays > 1 ? 's' : '');
            }
            
            document.getElementById('travel-port-name').textContent = portName;
            document.getElementById('travel-content').innerHTML = `
                <div class="port-info">
                    <h3>üìç ${gameState.currentPort} ‚Üí ${portName}</h3>
                    <p><strong>Distance:</strong> ${distance} nautical miles</p>
                    <p><strong>Travel Time:</strong> ${timeDisplay}</p>
                    <p><strong>Docking Cost:</strong> ${totalCost}‚öúÔ∏è</p>
                    <div class="specialties" style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #8b4513;">
                        <strong>üè≠ Produces:</strong> ${port.produces.join(', ')}<br>
                        <strong>üõí Demands:</strong> ${port.demands.join(', ')}
                    </div>
                </div>
                <button class="travel-btn" onclick="travelToPort()">‚öì Set Sail to ${portName}</button>
            `;
            
            openModal('travel-modal');
        }

        function travelToPort() {
            if (!selectedPort) return;
            
            const port = portData[selectedPort];
            const distance = getDistance(gameState.currentPort, selectedPort);
            const travelTimeHours = distance / (gameState.shipSpeed * 10);
            const travelDays = Math.max(1, Math.ceil(travelTimeHours / 24)); // Minimum 1 day
            const travelCost = travelDays * gameState.dailyCost;
            const portFee = Math.floor(gameState.dailyCost * 0.25); // Port fee = 1/4 of daily cost
            const totalCost = travelCost + portFee;
            
            // Calculate port stay fee for CURRENT port before leaving
            const stayInfo = calculatePortStayFee();
            const totalCostIncludingStay = totalCost + stayInfo.cost;
            
            // Check if player can afford EVERYTHING (stay fee + travel + port fee)
            if (gameState.money < totalCostIncludingStay) {
                showNotification(`üí∞ Not enough money! Need ${totalCostIncludingStay}‚öúÔ∏è (${stayInfo.cost}‚öúÔ∏è port stay + ${totalCost}‚öúÔ∏è travel)`, 'bad');
                return;
            }
            
            // Charge port stay fee BEFORE departing
            if (stayInfo.cost > 0) {
                gameState.money -= stayInfo.cost;
                gameState.day += stayInfo.days;
                logTransaction('fee', stayInfo.cost, `Port stay in ${gameState.currentPort} (${stayInfo.days} day${stayInfo.days > 1 ? 's' : ''}, ${stayInfo.unitsTraded} units traded)`);
                showNotification(`üèõÔ∏è Port stay: ${stayInfo.days} day${stayInfo.days > 1 ? 's' : ''} (${stayInfo.unitsTraded} units traded) = ${stayInfo.cost}‚öúÔ∏è`, 'warning');
                
                // Reset counters
                gameState.unitsSoldInPort = 0;
                gameState.unitsBoughtInPort = 0;
            }
            
            closeModal('travel-modal');
            
            let timeDisplay;
            if (travelTimeHours < 1) {
                timeDisplay = Math.round(travelTimeHours * 60) + ' minutes';
            } else if (travelTimeHours < 24) {
                timeDisplay = travelTimeHours.toFixed(1) + ' hours';
            } else {
                timeDisplay = travelDays + ' day' + (travelDays > 1 ? 's' : '');
            }
            
            // Show sailing animation
            showAnimation('travel', {
                destination: selectedPort,
                distance: distance,
                time: timeDisplay,
                callback: () => {
                    // Deduct travel cost
                    gameState.money -= travelCost;
                    logTransaction('fee', travelCost, `Travel from ${gameState.currentPort} to ${selectedPort} (${travelDays} day${travelDays > 1 ? 's' : ''})`);
                    showNotification(`üí∞ Paid ${travelCost}‚öúÔ∏è for ${travelDays} day${travelDays > 1 ? 's' : ''} of sailing`, 'warning');
                    
                    gameState.day += travelDays;
                    gameState.currentPort = selectedPort;
                    gameState.portsVisited.add(selectedPort);
                    
                    // Deduct port fee on arrival
                    gameState.money -= portFee;
                    logTransaction('fee', portFee, `Port fee at ${selectedPort}`);
                    showNotification(`üèõÔ∏è Paid ${portFee}‚öúÔ∏è port fee at ${selectedPort}`, 'warning');
                    
                    // Reset port trading counters
                    gameState.unitsSoldInPort = 0;
                    gameState.unitsBoughtInPort = 0;
                    
                    // Update UI
                    document.querySelectorAll('.port').forEach(p => p.classList.remove('current'));
                    document.getElementById(`port-${selectedPort}`).classList.add('current');
                    
                    // Move ship
                    const ship = document.getElementById('ship');
                    ship.style.left = port.x + '%';
                    ship.style.top = port.y + '%';
                    ship.textContent = ships[gameState.ship].emoji;
                    
                    // Check for loan interest
                    checkLoanInterest();
                    
                    // Random voyage event
                    triggerVoyageEvent();
                    
                    // Refresh market prices
                    updateMarketPrices();
                    
                    updateUI();
                    showNotification(`‚öì Arrived at ${selectedPort}!`, 'good');
                    saveGame();
                }
            });
        }

        // Random Voyage Events
        function triggerVoyageEvent() {
            const eventChance = Math.random();
            
            if (eventChance < 0.3) {
                const eventType = Math.random();
                
                if (eventType < 0.35) {
                    // Storm
                    const cargoKeys = Object.keys(gameState.cargo);
                    const shipDamage = Math.floor(10 + Math.random() * 20);
                    
                    gameState.shipHealth = Math.max(0, gameState.shipHealth - shipDamage);
                    gameState.cargoCapacity = Math.floor(gameState.maxCargoCapacity * (gameState.shipHealth / 100));
                    
                    let message = `Ship took ${shipDamage}% damage!<br>Cargo capacity reduced to ${gameState.cargoCapacity} tons`;
                    let lostGoodName = null;
                    let lostAmount = 0;
                    
                    if (cargoKeys.length > 0) {
                        lostGoodName = cargoKeys[Math.floor(Math.random() * cargoKeys.length)];
                        lostAmount = Math.ceil(gameState.cargo[lostGoodName] * (0.2 + Math.random() * 0.3));
                        gameState.cargo[lostGoodName] -= lostAmount;
                        if (gameState.cargo[lostGoodName] <= 0) delete gameState.cargo[lostGoodName];
                        message += `<br><br>Lost ${lostAmount} ${lostGoodName} to rough seas!`;
                        
                        logTransaction('storm', 0, `Storm damage: ${shipDamage}% hull damage, lost ${lostAmount} ${lostGoodName}`, lostGoodName);
                    } else {
                        logTransaction('storm', 0, `Storm damage: ${shipDamage}% hull damage`);
                    }
                    
                    showAnimation('storm', { message });
                    updateUI();
                    saveGame();
                }
                else if (eventType < 0.55) {
                    // Pirates
                    if (gameState.money > 100) {
                        const stolen = Math.ceil(gameState.money * (0.15 + Math.random() * 0.2));
                        gameState.money -= stolen;
                        
                        let message = `Pirates stole ${stolen}‚öúÔ∏è!`;
                        
                        if (Math.random() < 0.5) {
                            const damage = Math.floor(5 + Math.random() * 15);
                            gameState.shipHealth = Math.max(0, gameState.shipHealth - damage);
                            gameState.cargoCapacity = Math.floor(gameState.maxCargoCapacity * (gameState.shipHealth / 100));
                            message += `<br><br>Ship damaged ${damage}%!<br>Cargo capacity: ${gameState.cargoCapacity} tons`;
                            
                            logTransaction('pirate', stolen, `Pirate attack: stole ${stolen}‚öúÔ∏è, ${damage}% hull damage`);
                        } else {
                            logTransaction('pirate', stolen, `Pirate attack: stole ${stolen}‚öúÔ∏è`);
                        }
                        
                        showAnimation('pirate', { message });
                        showNotification(`üè¥‚Äç‚ò†Ô∏è Pirates stole ${stolen}‚öúÔ∏è!`, 'bad');
                        updateUI();
                        saveGame();
                    }
                }
                else if (eventType < 0.8) {
                    // Favorable winds
                    const bonus = Math.floor(50 + Math.random() * 150);
                    gameState.money += bonus;
                    logTransaction('income', bonus, `Favorable winds - saved costs`);
                    showNotification(`‚õµ Favorable winds! Saved ${bonus}‚öúÔ∏è in costs!`, 'good');
                    updateUI();
                    saveGame();
                }
                else {
                    // Lucky merchant
                    const bonus = Math.floor(100 + Math.random() * 200);
                    gameState.money += bonus;
                    logTransaction('income', bonus, `Lucky encounter with grateful merchant`);
                    showNotification(`ü§ù Met a grateful merchant! Received ${bonus}‚öúÔ∏è!`, 'good');
                    updateUI();
                    saveGame();
                }
            }
        }

        // Dynamic market price updates
        function updateMarketPrices() {
            const port = gameState.currentPort;
            const portInfo = portData[port];
            
            Object.keys(goodsData).forEach(good => {
                const currentPrice = marketPrices[port][good];
                const variance = 0.9 + Math.random() * 0.2;
                marketPrices[port][good] = Math.round(currentPrice * variance);
                
                // Update stock
                if (portInfo.produces.includes(good)) {
                    marketStock[port][good] = Math.floor(30 + Math.random() * 20);
                    marketDemand[port][good] = 0;
                } else if (portInfo.demands.includes(good)) {
                    marketStock[port][good] = Math.floor(10 + Math.random() * 10);
                    marketDemand[port][good] = Math.floor(20 + Math.random() * 30);
                } else if (marketStock[port][good] > 0) {
                    marketStock[port][good] = Math.floor(5 + Math.random() * 15);
                    marketDemand[port][good] = Math.floor(5 + Math.random() * 10);
                }
            });
        }

        // Market Functions
        function openMarket() {
            document.getElementById('market-port').textContent = gameState.currentPort;
            document.getElementById('market-money').textContent = gameState.money;
            document.getElementById('cargo-used').textContent = Object.values(gameState.cargo).reduce((a, b) => a + b, 0);
            document.getElementById('cargo-capacity').textContent = gameState.cargoCapacity;
            
            const prices = marketPrices[gameState.currentPort];
            const stock = marketStock[gameState.currentPort];
            const demand = marketDemand[gameState.currentPort];
            const portInfo = portData[gameState.currentPort];
            const isAthens = gameState.currentPort === 'Athens';
            
            // Show/hide tabs based on location
            const tabsElement = document.getElementById('market-tabs');
            if (isAthens) {
                tabsElement.style.display = 'flex';
            } else {
                tabsElement.style.display = 'none';
            }
            
            // Reset to regular market tab
            switchMarketTab('regular');
            
            // Random chance of finding mystery cargo
            if (Math.random() < 0.1 && Object.values(gameState.cargo).reduce((a, b) => a + b, 0) < gameState.cargoCapacity) {
                const availableGoods = gameState.unlockedGoods;
                const mysteryGood = availableGoods[Math.floor(Math.random() * availableGoods.length)];
                const mysteryAmount = Math.floor(1 + Math.random() * 3);
                gameState.cargo[mysteryGood] = (gameState.cargo[mysteryGood] || 0) + mysteryAmount;
                showNotification(`üéÅ Found ${mysteryAmount} ${mysteryGood} left by another merchant!`, 'good');
            }
            
            // Populate regular market
            populateRegularMarket(prices, stock, demand, portInfo, isAthens);
            
            // Populate general market (Athens only)
            if (isAthens) {
                populateGeneralMarket();
            }
            
            openModal('market-modal');
        }

        function switchMarketTab(tab) {
            // Update tab buttons
            const tabs = document.querySelectorAll('.market-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target?.classList.add('active');
            
            // Update content
            const regularContent = document.getElementById('regular-market-content');
            const generalContent = document.getElementById('general-market-content');
            
            if (tab === 'regular') {
                regularContent.classList.add('active');
                generalContent.classList.remove('active');
                tabs[0].classList.add('active');
            } else {
                regularContent.classList.remove('active');
                generalContent.classList.add('active');
                tabs[1].classList.add('active');
            }
        }

        function populateRegularMarket(prices, stock, demand, portInfo, isAthens) {
            document.getElementById('goods-grid').innerHTML = Object.keys(goodsData).map(good => {
                const price = prices[good];
                const inCargo = gameState.cargo[good] || 0;
                const availableStock = stock[good] || 0;
                const demandLimit = demand[good] || 0;
                const isProduced = portInfo.produces.includes(good);
                const isDemanded = portInfo.demands.includes(good);
                const isUnlocked = gameState.unlockedGoods.includes(good);
                const isAvailable = availableStock > 0;
                const canSell = demandLimit > 0;
                
                if (!isUnlocked) {
                    const unlockProfit = goodsData[good].unlockProfit;
                    return `
                        <div class="good-item locked">
                            <div class="good-header">
                                <div class="good-name">üîí ${good}</div>
                            </div>
                            <div class="cargo-info">Unlock at ${unlockProfit}‚öúÔ∏è total profit</div>
                        </div>
                    `;
                }
                
                if (!isAvailable && !canSell) {
                    return `
                        <div class="good-item" style="opacity: 0.6;">
                            <div class="good-header">
                                <div class="good-name">${goodsData[good].icon} ${good}</div>
                                <div class="good-price">‚Äî</div>
                            </div>
                            <div class="cargo-info">Not traded here</div>
                            ${inCargo > 0 ? `<div class="stock-info">In cargo: ${inCargo}</div>` : ''}
                            ${isAthens && inCargo > 0 ? '<div style="font-size: 0.85em; color: #f39c12; margin-top: 5px;">‚Üí Try General Market tab</div>' : ''}
                        </div>
                    `;
                }
                
                return `
                    <div class="good-item">
                        <div class="good-header">
                            <div class="good-name">${goodsData[good].icon} ${good}</div>
                            <div class="good-price">${price} ‚öúÔ∏è</div>
                        </div>
                        ${isProduced ? '<div style="color: #16a085; font-weight: bold; font-size: 0.9em;">üì¶ Abundant (Cheap)</div>' : ''}
                        ${isDemanded ? '<div style="color: #e74c3c; font-weight: bold; font-size: 0.9em;">üî• High Demand</div>' : ''}
                        <div class="cargo-info">In cargo: ${inCargo} tons</div>
                        ${availableStock > 0 ? `<div class="stock-info">Available to buy: ${availableStock} tons</div>` : ''}
                        ${canSell ? `<div class="stock-info" style="color: #27ae60;">Will buy: ${demandLimit} tons</div>` : '<div class="stock-info" style="color: #999;">Not buying</div>'}
                        <div class="good-controls">
                            <input type="number" id="qty-${good}" value="5" min="1" max="${Math.min(50, availableStock || demandLimit)}" 
                                onchange="updateTotalCost('${good}', ${price})" 
                                oninput="updateTotalCost('${good}', ${price})">
                            <button class="buy-btn" onclick="buyGood('${good}')" ${availableStock === 0 ? 'disabled' : ''}>
                                Buy <span id="buy-total-${good}" style="font-size: 0.9em;">(${price * 5}‚öúÔ∏è)</span>
                            </button>
                            <button class="sell-btn" onclick="sellGood('${good}')" ${inCargo === 0 || !canSell ? 'disabled' : ''}>
                                Sell <span id="sell-total-${good}" style="font-size: 0.9em;">(${price * 5}‚öúÔ∏è)</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populateGeneralMarket() {
            document.getElementById('general-goods-grid').innerHTML = gameState.unlockedGoods.map(good => {
                const inCargo = gameState.cargo[good] || 0;
                const basePrice = goodsData[good].basePrice;
                const athensPrice = Math.floor(basePrice * 0.5);
                
                if (inCargo === 0) {
                    return `
                        <div class="good-item" style="opacity: 0.5;">
                            <div class="good-header">
                                <div class="good-name">${goodsData[good].icon} ${good}</div>
                                <div class="good-price">${athensPrice} ‚öúÔ∏è</div>
                            </div>
                            <div class="cargo-info">No cargo to sell</div>
                        </div>
                    `;
                }
                
                return `
                    <div class="good-item">
                        <div class="good-header">
                            <div class="good-name">${goodsData[good].icon} ${good}</div>
                            <div class="good-price">${athensPrice} ‚öúÔ∏è</div>
                        </div>
                        <div style="font-size: 0.9em; color: #f39c12; font-weight: bold; margin-bottom: 8px;">50% of base price</div>
                        <div class="cargo-info">In cargo: ${inCargo} tons</div>
                        <div class="good-controls">
                            <input type="number" id="athens-qty-${good}" value="${inCargo}" min="1" max="${inCargo}"
                                onchange="updateAthensTotalCost('${good}', ${athensPrice})" 
                                oninput="updateAthensTotalCost('${good}', ${athensPrice})">
                            <button class="sell-btn" onclick="sellInAthensMarket('${good}')" style="width: 100%;">
                                Sell <span id="athens-total-${good}" style="font-size: 0.9em;">(${athensPrice * inCargo}‚öúÔ∏è)</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateAthensTotalCost(goodName, pricePerUnit) {
            const qty = parseInt(document.getElementById(`athens-qty-${goodName}`).value) || 0;
            const total = pricePerUnit * qty;
            
            const totalElement = document.getElementById(`athens-total-${goodName}`);
            if (totalElement) {
                totalElement.textContent = `(${total}‚öúÔ∏è)`;
            }
        }

        // Transaction logging
        function logTransaction(type, amount, description, good = null) {
            gameState.transactions.push({
                day: gameState.day,
                type: type, // 'income', 'expense', 'storm', 'pirate', 'fee'
                amount: Math.abs(amount),
                description: description,
                good: good
            });
            
            // Keep only last 500 transactions to avoid performance issues
            if (gameState.transactions.length > 500) {
                gameState.transactions = gameState.transactions.slice(-500);
            }
        }

        function sellInAthensMarket(goodName) {
            const qty = parseInt(document.getElementById(`athens-qty-${goodName}`).value);
            const inCargo = gameState.cargo[goodName] || 0;
            
            if (inCargo < qty) {
                showNotification('Not enough in cargo!', 'bad');
                return;
            }
            
            const basePrice = goodsData[goodName].basePrice;
            const athensPrice = Math.floor(basePrice * 0.5);
            const totalEarned = athensPrice * qty;
            
            gameState.money += totalEarned;
            gameState.cargo[goodName] -= qty;
            if (gameState.cargo[goodName] === 0) delete gameState.cargo[goodName];
            
            // Track units sold for port stay calculation
            gameState.unitsSoldInPort += qty;
            
            // Track profit (simplified)
            gameState.totalProfit += totalEarned;
            gameState.goodsProfit[goodName] += totalEarned;
            
            logTransaction('income', totalEarned, `Sold ${qty} ${goodName} to Athens General Market`, goodName);
            
            showNotification(`üèõÔ∏è Athens merchants bought ${qty} ${goodName} for ${totalEarned}‚öúÔ∏è (50% base price)`, 'good');
            
            checkGoodsUnlocks();
            openMarket();
            updateUI();
            saveGame();
        }

        // Update total cost display when quantity changes
        function updateTotalCost(goodName, pricePerUnit) {
            const qty = parseInt(document.getElementById(`qty-${goodName}`).value) || 0;
            const total = pricePerUnit * qty;
            
            const buyTotalElement = document.getElementById(`buy-total-${goodName}`);
            const sellTotalElement = document.getElementById(`sell-total-${goodName}`);
            
            if (buyTotalElement) {
                buyTotalElement.textContent = `(${total}‚öúÔ∏è)`;
            }
            if (sellTotalElement) {
                sellTotalElement.textContent = `(${total}‚öúÔ∏è)`;
            }
        }

        function buyGood(goodName) {
            const qty = parseInt(document.getElementById(`qty-${goodName}`).value);
            const price = marketPrices[gameState.currentPort][goodName];
            const availableStock = marketStock[gameState.currentPort][goodName];
            const totalCost = price * qty;
            
            if (qty > availableStock) {
                showNotification(`Only ${availableStock} ${goodName} available!`, 'bad');
                return;
            }
            
            const currentCargo = Object.values(gameState.cargo).reduce((a, b) => a + b, 0);
            
            if (currentCargo + qty > gameState.cargoCapacity) {
                showNotification('Not enough cargo space!', 'bad');
                return;
            }
            
            if (gameState.money < totalCost) {
                showNotification('Not enough drachmas!', 'bad');
                return;
            }
            
            gameState.money -= totalCost;
            gameState.cargo[goodName] = (gameState.cargo[goodName] || 0) + qty;
            marketStock[gameState.currentPort][goodName] -= qty;
            
            // Track units bought for port stay calculation
            gameState.unitsBoughtInPort += qty;
            
            logTransaction('expense', totalCost, `Bought ${qty} ${goodName} in ${gameState.currentPort}`, goodName);
            
            showNotification(`üí∞ Spent ${totalCost}‚öúÔ∏è buying ${qty} ${goodName}`, 'warning');
            openMarket();
            updateUI();
            saveGame();
        }

        function sellGood(goodName) {
            const qty = parseInt(document.getElementById(`qty-${goodName}`).value);
            const inCargo = gameState.cargo[goodName] || 0;
            const demandLimit = marketDemand[gameState.currentPort][goodName] || 0;
            
            if (inCargo < qty) {
                showNotification('Not enough in cargo!', 'bad');
                return;
            }
            
            if (demandLimit === 0) {
                showNotification('This port is not buying this good!', 'bad');
                return;
            }
            
            const actualQty = Math.min(qty, demandLimit);
            
            if (actualQty < qty) {
                showNotification(`Port will only buy ${actualQty} units (demand limit reached)`, 'warning');
            }
            
            const price = marketPrices[gameState.currentPort][goodName];
            const totalEarned = price * actualQty;
            
            gameState.money += totalEarned;
            gameState.cargo[goodName] -= actualQty;
            if (gameState.cargo[goodName] === 0) delete gameState.cargo[goodName];
            
            // Decrease demand limit
            marketDemand[gameState.currentPort][goodName] -= actualQty;
            
            // Track units sold for port stay calculation
            gameState.unitsSoldInPort += actualQty;
            
            // Track profit
            const profit = totalEarned;
            gameState.totalProfit += profit;
            gameState.goodsProfit[goodName] += profit;
            
            logTransaction('income', totalEarned, `Sold ${actualQty} ${goodName} in ${gameState.currentPort}`, goodName);
            
            showNotification(`‚úÖ Sold ${actualQty} ${goodName} for ${totalEarned}‚öúÔ∏è`, 'good');
            
            // Check for goods unlocks
            checkGoodsUnlocks();
            
            openMarket();
            updateUI();
            saveGame();
        }

        // Goods Unlocking
        function checkGoodsUnlocks() {
            Object.keys(goodsData).forEach(good => {
                if (!gameState.unlockedGoods.includes(good)) {
                    const unlockProfit = goodsData[good].unlockProfit;
                    if (gameState.totalProfit >= unlockProfit) {
                        gameState.unlockedGoods.push(good);
                        showNotification(`üéâ New good unlocked: ${good}!`, 'good');
                    }
                }
            });
        }

        // Ship Functions
        function openShipMenu() {
            const upgradePort = gameState.currentPort === 'Athens' || gameState.currentPort === 'Sparta';
            const hasShip = gameState.ship !== null;
            let currentShipData = hasShip ? ships[gameState.ship] : null;
            let repairCost = 0;
            let needsRepair = false;
            
            if (hasShip) {
                repairCost = Math.ceil(currentShipData.cost * 0.5 * (100 - gameState.shipHealth) / 100);
                needsRepair = gameState.shipHealth < 100;
            }
            
            let content = '';
            
            // NO SHIP WARNING
            if (!hasShip) {
                content += `
                    <div style="background: #fadbd8; padding: 30px; border-radius: 10px; border: 5px solid #e74c3c; margin-bottom: 20px; text-align: center;">
                        <h2 style="color: #c0392b; margin-bottom: 15px; font-size: 2em;">‚ö†Ô∏è NO SHIP!</h2>
                        <p style="font-size: 1.3em; margin-bottom: 20px;">You sold your ship and now have NO WAY TO TRADE!</p>
                        <p style="font-size: 1.1em; color: #c0392b; font-weight: bold;">BUY A SHIP IMMEDIATELY OR GO BANKRUPT!</p>
                    </div>
                `;
            }
            // Repair Section (only if has ship)
            else if (needsRepair) {
                content += `
                    <div style="background: #fadbd8; padding: 20px; border-radius: 10px; border: 3px solid #e74c3c; margin-bottom: 20px;">
                        <h3 style="color: #c0392b; margin-bottom: 10px;">üîß Ship Repairs Needed</h3>
                        <p style="margin: 10px 0;"><strong>Current Health:</strong> ${gameState.shipHealth}%</p>
                        <p style="margin: 10px 0;"><strong>Cargo Capacity:</strong> ${gameState.cargoCapacity} / ${gameState.maxCargoCapacity} tons</p>
                        <p style="margin: 10px 0;"><strong>Repair Cost:</strong> ${repairCost}‚öúÔ∏è (50% of ship value)</p>
                        ${upgradePort ? 
                            `<button class="upgrade-btn" onclick="repairShip()" ${gameState.money < repairCost ? 'disabled' : ''}>
                                Repair Ship to 100%
                            </button>` : 
                            `<p style="color: #e74c3c; font-weight: bold;">‚ö†Ô∏è Repairs only in Athens/Sparta</p>`
                        }
                    </div>
                `;
            } else if (hasShip) {
                content += `
                    <div style="background: #d5f4e6; padding: 15px; border-radius: 10px; border: 2px solid #27ae60; margin-bottom: 20px;">
                        <p style="color: #27ae60; font-weight: bold;">‚úì Ship in perfect condition (${gameState.shipHealth}%)</p>
                    </div>
                `;
            }
            
            // Ships Section
            content += '<h3 style="margin: 20px 0 10px 0;">‚õµ Available Ships</h3>';
            content += '<div class="ship-grid">';
            
            Object.keys(ships).forEach(shipName => {
                const ship = ships[shipName];
                const isCurrent = hasShip && gameState.ship === shipName;
                const canAfford = gameState.money >= ship.cost;
                const sellValue = Math.floor(ship.cost * 0.7);
                const speedNauticalMiles = Math.round(ship.speed * 10); // Convert speed to nautical miles per hour
                
                content += `
                    <div class="ship-card ${isCurrent ? 'current' : ''}">
                        <div class="ship-icon">${ship.emoji}</div>
                        <div class="ship-name">${shipName}</div>
                        <div class="ship-stats">
                            <div>üì¶ Cargo Capacity: ${ship.capacity} tons</div>
                            <div>‚ö° Speed: ${speedNauticalMiles} nm/h</div>
                            <div>üí∞ Daily Maintenance: ${ship.dailyCost}‚öúÔ∏è</div>
                            <div>üîß Full Repair: ${Math.ceil(ship.cost * 0.5)}‚öúÔ∏è</div>
                        </div>
                        ${isCurrent ? `
                            <div style="color: #27ae60; font-weight: bold; margin-top: 10px;">‚úì Current Ship</div>
                            ${upgradePort ? `
                                <button class="sell-ship-btn upgrade-btn" onclick="sellShip()">
                                    Sell for ${sellValue}‚öúÔ∏è
                                </button>
                            ` : ''}
                        ` : `
                            <button class="upgrade-btn" onclick="buyShip('${shipName}')" 
                                ${!canAfford || !upgradePort ? 'disabled' : ''}>
                                Buy for ${ship.cost}‚öúÔ∏è
                            </button>
                        `}
                    </div>
                `;
            });
            
            content += '</div>';
            
            if (!upgradePort) {
                content = `<p style="color: #e74c3c; font-weight: bold; text-align: center; padding: 15px; background: #fadbd8; border-radius: 10px; margin-bottom: 20px;">‚ö†Ô∏è Ship upgrades only available in Athens or Sparta</p>` + content;
            }
            
            document.getElementById('ship-content').innerHTML = content;
            openModal('ship-modal');
        }

        function repairShip() {
            const currentShipData = ships[gameState.ship];
            const repairCost = Math.ceil(currentShipData.cost * 0.5 * (100 - gameState.shipHealth) / 100);
            
            if (gameState.money < repairCost) {
                showNotification('Not enough drachmas for repairs!', 'bad');
                return;
            }
            
            gameState.money -= repairCost;
            gameState.shipHealth = 100;
            gameState.cargoCapacity = gameState.maxCargoCapacity;
            
            showNotification(`üîß Ship repaired to 100% for ${repairCost}‚öúÔ∏è`, 'good');
            showNotification(`üí∞ Paid ${repairCost}‚öúÔ∏è for repairs`, 'warning');
            updateUI();
            openShipMenu();
            saveGame();
        }

        function buyShip(shipName) {
            const ship = ships[shipName];
            
            if (gameState.money < ship.cost) {
                showNotification('Not enough drachmas!', 'bad');
                return;
            }
            
            gameState.money -= ship.cost;
            gameState.ship = shipName;
            gameState.cargoCapacity = ship.capacity;
            gameState.maxCargoCapacity = ship.capacity;
            gameState.shipSpeed = ship.speed;
            gameState.dailyCost = ship.dailyCost;
            gameState.shipHealth = 100;
            gameState.hasUpgradedShip = true;
            
            // Update ship icon on map
            document.getElementById('ship').textContent = ship.emoji;
            
            // Unlock new ports
            unlockPorts();
            
            showNotification(`‚õµ Purchased ${shipName}!`, 'good');
            showNotification(`üí∞ Spent ${ship.cost}‚öúÔ∏è on new ship`, 'warning');
            updateUI();
            openShipMenu();
            saveGame();
        }

        function sellShip() {
            const currentShipData = ships[gameState.ship];
            const sellValue = Math.floor(currentShipData.cost * 0.7);
            
            if (confirm(`Sell ${gameState.ship} for ${sellValue}‚öúÔ∏è?\n\n‚ö†Ô∏è WARNING: You will have NO SHIP until you buy another one!\n\nIf you can't afford a ship, it's GAME OVER.`)) {
                gameState.money += sellValue;
                
                // Store cargo that will be lost
                const totalCargo = Object.values(gameState.cargo).reduce((a, b) => a + b, 0);
                
                // Clear ship icon on map
                document.getElementById('ship').textContent = '‚ùå';
                
                // Clear everything
                gameState.ship = null;
                gameState.cargoCapacity = 0;
                gameState.maxCargoCapacity = 0;
                gameState.shipSpeed = 0;
                gameState.dailyCost = 0;
                gameState.shipHealth = 0;
                gameState.cargo = {}; // Lose all cargo
                
                showNotification(`üí∞ Sold ship for ${sellValue}‚öúÔ∏è`, 'good');
                
                if (totalCargo > 0) {
                    showNotification(`‚ö†Ô∏è Lost ${totalCargo} tons of cargo - you have no ship!`, 'bad');
                }
                
                // Check if player can afford ANY ship
                const cheapestShip = Math.min(...Object.values(ships).map(s => s.cost));
                if (gameState.money < cheapestShip) {
                    // GAME OVER - Can't afford any ship
                    closeModal('ship-modal');
                    showAnimation('bankrupt', {
                        message: `You sold your ship for ${sellValue}‚öúÔ∏è<br><br>But you can't afford to buy another ship!<br>(Cheapest ship: ${cheapestShip}‚öúÔ∏è)<br><br>Without a ship, you cannot trade.<br><br>GAME OVER`
                    });
                } else {
                    showNotification(`‚ö†Ô∏è You have NO SHIP! Buy one immediately or you're bankrupt!`, 'warning');
                }
                
                updateUI();
                openShipMenu(); // Refresh the ship menu
                saveGame();
            }
        }

        // Loan Functions
        function takeLoan() {
            const amount = parseInt(document.getElementById('loan-amount').value);
            const currentShipData = ships[gameState.ship];
            const netWorth = gameState.money + (Object.values(gameState.cargo).reduce((sum, qty) => {
                const good = Object.keys(gameState.cargo).find(g => gameState.cargo[g] === qty);
                return sum + (marketPrices[gameState.currentPort][good] || 0) * qty;
            }, 0)) + currentShipData.cost;
            
            if (amount > netWorth) {
                showNotification('Loan exceeds your net worth!', 'bad');
                return;
            }
            
            if (amount < 100) {
                showNotification('Minimum loan is 100‚öúÔ∏è', 'bad');
                return;
            }
            
            gameState.loan = amount;
            gameState.money += amount;
            gameState.loanTaken = true;
            gameState.lastLoanInterestDay = gameState.day;
            
            showNotification(`üí∞ Received loan of ${amount}‚öúÔ∏è`, 'good');
            showNotification(`‚ö†Ô∏è 10% interest due in 12 days (Day ${gameState.day + 12})`, 'warning');
            updateUI();
            openShipMenu();
            saveGame();
        }

        function repayLoan() {
            if (gameState.money < gameState.loan) {
                showNotification('Not enough money to repay loan!', 'bad');
                return;
            }
            
            gameState.money -= gameState.loan;
            showNotification(`‚úÖ Loan of ${gameState.loan}‚öúÔ∏è repaid!`, 'good');
            showNotification(`üí∞ Paid ${gameState.loan}‚öúÔ∏è to bank`, 'warning');
            gameState.loan = 0;
            gameState.loanTaken = false;
            
            updateUI();
            openShipMenu();
            saveGame();
        }

        function checkLoanInterest() {
            if (gameState.loan > 0 && gameState.day >= gameState.lastLoanInterestDay + 12) {
                const interest = Math.ceil(gameState.loan * 0.1);
                gameState.lastLoanInterestDay = gameState.day;
                
                if (gameState.money >= interest) {
                    gameState.money -= interest;
                    showNotification(`üí∞ Paid ${interest}‚öúÔ∏è loan interest`, 'warning');
                } else {
                    // Can't pay - bankruptcy process
                    handleBankruptcy();
                }
                
                updateUI();
                saveGame();
            }
        }

        function handleBankruptcy() {
            const currentShipData = ships[gameState.ship];
            const totalDebt = gameState.loan + Math.ceil(gameState.loan * 0.1);
            const shipValue = currentShipData.cost;
            
            // Seize money
            const moneySeized = gameState.money;
            gameState.money = 0;
            
            // Seize cargo
            let cargoValue = 0;
            Object.keys(gameState.cargo).forEach(good => {
                cargoValue += (marketPrices[gameState.currentPort][good] || 0) * gameState.cargo[good];
            });
            gameState.cargo = {};
            
            const totalSeized = moneySeized + cargoValue;
            const remainingDebt = totalDebt - totalSeized;
            
            if (remainingDebt > shipValue) {
                // Game over - debt exceeds ship value
                showAnimation('bankrupt', {
                    message: `You couldn't pay your debt of ${totalDebt}‚öúÔ∏è<br><br>The bank seized:<br>üí∞ ${moneySeized}‚öúÔ∏è in money<br>üì¶ ${cargoValue}‚öúÔ∏è in cargo<br>‚õµ Your ${gameState.ship}<br><br>Remaining debt of ${remainingDebt}‚öúÔ∏è exceeds ship value.<br><br>GAME OVER`
                });
            } else {
                // Downgrade to merchant, give difference as cash
                const difference = shipValue - remainingDebt;
                gameState.ship = 'Merchant';
                gameState.cargoCapacity = 50;
                gameState.maxCargoCapacity = 50;
                gameState.shipSpeed = 1;
                gameState.dailyCost = 30;
                gameState.shipHealth = 100;
                gameState.money = difference;
                gameState.loan = 0;
                gameState.loanTaken = false;
                
                document.getElementById('ship').textContent = ships['Merchant'].emoji;
                
                showNotification(`üí• BANKRUPTCY! Bank seized cargo and ship. You have ${difference}‚öúÔ∏è left.`, 'bad');
                updateUI();
                saveGame();
            }
        }

        // Bank Modal
        function openBank() {
            if (gameState.currentPort !== 'Athens') {
                showNotification('üè¶ Bank services only available in Athens', 'bad');
                return;
            }
            
            if (!gameState.hasUpgradedShip) {
                showNotification('üîí Bank unlocks after your first ship upgrade', 'bad');
                return;
            }
            
            let content = '';
            
            const cargoValue = Object.values(gameState.cargo).reduce((sum, qty) => {
                const good = Object.keys(gameState.cargo).find(g => gameState.cargo[g] === qty);
                return sum + (marketPrices[gameState.currentPort][good] || 0) * qty;
            }, 0);
            const shipValue = gameState.ship ? ships[gameState.ship].cost : 0;
            const netWorth = gameState.money + cargoValue + shipValue;
            const maxLoan = netWorth;
            
            content += `
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 3px solid #f39c12; margin-bottom: 20px;">
                    <h3 style="color: #d68910; margin-bottom: 15px;">üè¶ Bank of Athens</h3>
                    <p style="margin-bottom: 10px;">The most trusted financial institution in the Aegean Sea</p>
                </div>
                
                <div class="loan-section">
                    <h3>üí∞ Your Finances</h3>
                    <div class="loan-info" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong>Cash on Hand:</strong> ${gameState.money}‚öúÔ∏è<br>
                        <strong>Cargo Value:</strong> ${cargoValue}‚öúÔ∏è<br>
                        <strong>Ship Value:</strong> ${shipValue}‚öúÔ∏è<br>
                        <strong style="color: #27ae60;">Net Worth:</strong> ${netWorth}‚öúÔ∏è<br>
                    </div>
                    
                    <h3>üìú Loan Terms</h3>
                    <div class="loan-info" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <strong>Maximum Loan:</strong> ${maxLoan}‚öúÔ∏è (equals your net worth)<br>
                        <strong>Interest Rate:</strong> 10% every 12 days<br>
                        <strong>Repayment:</strong> Anytime (early repayment to avoid interest)<br>
                    </div>
                    
                    ${gameState.loan > 0 ? `
                        <div style="background: #fadbd8; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #e74c3c;">
                            <h3 style="color: #c0392b; margin-bottom: 10px;">‚ö†Ô∏è Active Loan</h3>
                            <strong style="color: #c0392b; font-size: 1.2em;">Current Debt:</strong> ${gameState.loan}‚öúÔ∏è<br>
                            <strong>Next Interest Payment:</strong> Day ${gameState.lastLoanInterestDay + 12}<br>
                            <strong>Interest Amount:</strong> ${Math.ceil(gameState.loan * 0.1)}‚öúÔ∏è
                        </div>
                        <button class="upgrade-btn" onclick="repayLoan()">Repay Full Loan (${gameState.loan}‚öúÔ∏è)</button>
                    ` : `
                        <div style="background: #d5f4e6; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #27ae60;">
                            <p style="color: #27ae60; font-weight: bold;">‚úì No active loans</p>
                        </div>
                        <input type="number" id="loan-amount" placeholder="Enter loan amount" min="100" max="${maxLoan}" 
                            style="width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; border: 2px solid #f39c12; font-size: 1.1em;">
                        <button class="upgrade-btn" onclick="takeLoan()">Take Loan</button>
                    `}
                    
                    <div class="loan-warning" style="margin-top: 20px;">
                        ‚ö†Ô∏è <strong>Warning:</strong> If you cannot pay interest when due, your assets will be seized in this order:<br>
                        1. Cash<br>
                        2. Cargo (sold at market price)<br>
                        3. Ship (if debt exceeds ship value: BANKRUPTCY)
                    </div>
                </div>
            `;
            
            document.getElementById('bank-content').innerHTML = content;
            openModal('bank-modal');
        }

        // Logbook Modal
        function openLogbook() {
            // Reset to transactions tab (now primary)
            switchLogbookTab('transactions');
            
            // Populate progress tab
            populateProgressTab();
            
            // Populate transactions tab
            populateTransactionsTab();
            
            openModal('logbook-modal');
        }

        function switchLogbookTab(tab) {
            const tabs = document.querySelectorAll('#logbook-modal .market-tab');
            tabs.forEach(t => t.classList.remove('active'));
            
            const progressContent = document.getElementById('logbook-progress-content');
            const transactionsContent = document.getElementById('logbook-transactions-content');
            
            if (tab === 'transactions') {
                transactionsContent.classList.add('active');
                progressContent.classList.remove('active');
                tabs[0].classList.add('active');
            } else {
                transactionsContent.classList.remove('active');
                progressContent.classList.add('active');
                tabs[1].classList.add('active');
            }
        }

        function populateProgressTab() {
            let content = '<div class="progress-section">';
            content += '<h3 style="color: #16a085; margin-bottom: 20px;">üìä Trading Progress</h3>';
            
            content += '<div class="progress-item">';
            content += `<strong>Total Profit:</strong> ${gameState.totalProfit}‚öúÔ∏è`;
            content += '</div>';
            
            // Goods unlock progress
            const nextUnlock = Object.keys(goodsData).find(g => !gameState.unlockedGoods.includes(g));
            if (nextUnlock) {
                const unlockProfit = goodsData[nextUnlock].unlockProfit;
                const progress = Math.min(100, (gameState.totalProfit / unlockProfit) * 100);
                content += '<div class="progress-item">';
                content += `<strong>Next Unlock:</strong> ${nextUnlock} at ${unlockProfit}‚öúÔ∏è`;
                content += `<div class="progress-bar"><div class="progress-fill" style="width: ${progress}%">${progress.toFixed(0)}%</div></div>`;
                content += '</div>';
            }
            
            // Goods profit breakdown
            content += '<h4 style="margin-top: 20px;">Profit by Good:</h4>';
            gameState.unlockedGoods.forEach(good => {
                const profit = gameState.goodsProfit[good];
                content += `<div class="progress-item"><strong>${goodsData[good].icon} ${good}:</strong> ${profit}‚öúÔ∏è</div>`;
            });
            
            content += '</div>';
            
            document.getElementById('logbook-progress-content').innerHTML = content;
        }

        function populateTransactionsTab() {
            filterTransactions();
        }

        function filterTransactions() {
            const filter = document.getElementById('transaction-filter').value;
            let transactions = [...gameState.transactions];
            
            // Apply filter
            if (filter !== 'all') {
                if (filter === 'goods') {
                    transactions = transactions.filter(t => t.good !== null);
                } else {
                    transactions = transactions.filter(t => t.type === filter);
                }
            }
            
            // Sort by day (most recent first)
            transactions.sort((a, b) => b.day - a.day);
            
            let html = '';
            
            if (transactions.length === 0) {
                html = '<p style="text-align: center; color: #666; padding: 40px;">No transactions recorded yet.</p>';
            } else {
                html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                
                transactions.forEach(t => {
                    let bgColor = '#f0f0f0';
                    let icon = 'üí∞';
                    let sign = '+';
                    
                    if (t.type === 'income') {
                        bgColor = '#d5f4e6';
                        icon = '‚úÖ';
                        sign = '+';
                    } else if (t.type === 'expense') {
                        bgColor = '#fadbd8';
                        icon = 'üí∏';
                        sign = '-';
                    } else if (t.type === 'storm') {
                        bgColor = '#fadbd8';
                        icon = '‚õàÔ∏è';
                        sign = '-';
                    } else if (t.type === 'pirate') {
                        bgColor = '#fadbd8';
                        icon = 'üè¥‚Äç‚ò†Ô∏è';
                        sign = '-';
                    } else if (t.type === 'fee') {
                        bgColor = '#fff3cd';
                        icon = 'üìú';
                        sign = '-';
                    }
                    
                    html += `
                        <div style="background: ${bgColor}; padding: 15px; border-radius: 8px; border: 2px solid #8b4513; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: bold; margin-bottom: 5px;">${icon} Day ${t.day} - ${t.description}</div>
                                ${t.good ? `<div style="font-size: 0.9em; color: #666;">Good: ${goodsData[t.good].icon} ${t.good}</div>` : ''}
                            </div>
                            <div style="font-size: 1.3em; font-weight: bold; ${t.type === 'income' ? 'color: #27ae60;' : 'color: #e74c3c;'}">
                                ${sign}${t.amount}‚öúÔ∏è
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            document.getElementById('transactions-list').innerHTML = html;
        }

        // Port Unlocking
        function unlockPorts() {
            Object.keys(portData).forEach(portName => {
                const port = portData[portName];
                if (port.unlockedAt === gameState.ship || 
                    (port.unlockedAt === 'Bireme' && ['Bireme', 'Trireme', 'War Galley'].includes(gameState.ship)) ||
                    (port.unlockedAt === 'Trireme' && ['Trireme', 'War Galley'].includes(gameState.ship)) ||
                    (port.unlockedAt === 'War Galley' && gameState.ship === 'War Galley')) {
                    
                    const portElement = document.getElementById(`port-${portName}`);
                    if (portElement.classList.contains('locked')) {
                        portElement.classList.remove('locked');
                        portElement.querySelector('.port-label').textContent = portName;
                        showNotification(`üó∫Ô∏è New port unlocked: ${portName}!`, 'good');
                    }
                }
            });
        }

        // UI Functions
        function updateUI() {
            document.getElementById('money').textContent = gameState.money;
            document.getElementById('day').textContent = gameState.day;
            
            // Show/hide bank button
            const bankButton = document.getElementById('bank-button');
            if (gameState.hasUpgradedShip) {
                bankButton.style.display = 'inline-block';
            } else {
                bankButton.style.display = 'none';
            }
            
            // Handle no ship case
            if (gameState.ship) {
                document.getElementById('ship-health').textContent = gameState.shipHealth + '%';
                document.getElementById('ship-type').textContent = gameState.ship;
                
                // Health color
                const healthDisplay = document.getElementById('ship-health');
                if (gameState.shipHealth < 50) {
                    healthDisplay.style.color = '#e74c3c';
                } else if (gameState.shipHealth < 80) {
                    healthDisplay.style.color = '#f39c12';
                } else {
                    healthDisplay.style.color = '#27ae60';
                }
            } else {
                document.getElementById('ship-health').textContent = 'NO SHIP';
                document.getElementById('ship-health').style.color = '#e74c3c';
                document.getElementById('ship-type').textContent = '‚Äî';
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Save/Load
        function saveGame() {
            localStorage.setItem('aegeanTrader', JSON.stringify({
                ...gameState,
                portsVisited: Array.from(gameState.portsVisited)
            }));
        }

        function loadGame() {
            const saved = localStorage.getItem('aegeanTrader');
            if (saved) {
                const data = JSON.parse(saved);
                Object.assign(gameState, data);
                gameState.portsVisited = new Set(data.portsVisited || ['Athens']);
                
                // Ensure new properties exist
                if (gameState.shipHealth === undefined) gameState.shipHealth = 100;
                if (gameState.maxCargoCapacity === undefined) gameState.maxCargoCapacity = gameState.cargoCapacity;
                if (gameState.goodsProfit === undefined) gameState.goodsProfit = {
                    'Olive Oil': 0, 'Wine': 0, 'Timber': 0, 'Pottery': 0,
                    'Grain': 0, 'Bronze': 0, 'Marble': 0, 'Purple Dye': 0
                };
                if (gameState.unlockedGoods === undefined) gameState.unlockedGoods = ['Olive Oil'];
                if (gameState.totalProfit === undefined) gameState.totalProfit = 0;
                if (gameState.hasUpgradedShip === undefined) gameState.hasUpgradedShip = false;
                if (gameState.transactions === undefined) gameState.transactions = [];
                if (gameState.unitsSoldInPort === undefined) gameState.unitsSoldInPort = 0;
                if (gameState.unitsBoughtInPort === undefined) gameState.unitsBoughtInPort = 0;
                
                // Update dailyCost to new values if using old save
                if (gameState.ship === 'Merchant' && gameState.dailyCost === 30) gameState.dailyCost = 20;
                if (gameState.ship === 'Bireme' && gameState.dailyCost === 80) gameState.dailyCost = 53;
                if (gameState.ship === 'Trireme' && gameState.dailyCost === 150) gameState.dailyCost = 100;
                if (gameState.ship === 'War Galley' && gameState.dailyCost === 250) gameState.dailyCost = 167;
                
                // Update ship position
                const port = portData[gameState.currentPort];
                const shipEl = document.getElementById('ship');
                shipEl.style.left = port.x + '%';
                shipEl.style.top = port.y + '%';
                shipEl.textContent = ships[gameState.ship].emoji;
                
                // Update ports
                document.querySelectorAll('.port').forEach(p => p.classList.remove('current'));
                document.getElementById(`port-${gameState.currentPort}`).classList.add('current');
                
                // Unlock ports based on ship
                unlockPorts();
                
                updateUI();
            }
        }

        function restartGame() {
            if (confirm('Start a new game? All progress will be lost.')) {
                localStorage.removeItem('aegeanTrader');
                location.reload();
            }
        }

        // Initialize
        function init() {
            initMarketPrices();
            loadGame();
            updateUI();
        }

        init();
    </script>
</body>
</html>
